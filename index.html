<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <title>ØªÙ† ÙÙŠØ² â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØ£Ø³ÙŠØ³ ===== */
    :root {
      --primary: #2563eb; --primary-dark: #1e40af; --primary-light: #eff6ff;
      --accent: #10b981; --warn: #f43f5e; --gold: #f59e0b;
      --bg: #f8fafc; --surface: #ffffff;
      --text-main: #0f172a; --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.02);
      --radius: 14px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0; padding: 0;
      min-height: 100vh;
      padding-bottom: 100px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„ØªÙˆØ³Øª */
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===== */
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding: 20px 0;
    }
    .header h1 {
      font-size: 28px; font-weight: 800; margin: 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header p { color: var(--text-muted); margin: 6px 0 0; font-size: 14px; }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }

    /* ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… (Inputs & Buttons) ===== */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      align-items: center;
    }

    input[type=text], input[type=number] {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
      font-family: inherit; font-size: 16px; font-weight: 600;
      background: var(--bg);
      transition: all 0.2s;
      outline: none;
    }
    input:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 4px var(--primary-light);
    }

    button {
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      font-family: inherit; font-size: 15px; font-weight: 700;
      cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s active 0.1s;
      user-select: none;
    }
    button:active { transform: scale(0.97); }

    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
    .btn-primary:hover { background: var(--primary-dark); }
    
    .btn-ghost { background: var(--primary-light); color: var(--primary-dark); }
    .btn-ghost:hover { background: #dbeafe; }

    .btn-success { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .btn-danger { background: var(--warn); color: #fff; }

    /* ===== Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØºØ±ÙØ© ===== */
    .room-header {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .badge {
      display: inline-flex; align-items: center;
      padding: 4px 12px; border-radius: 99px;
      font-size: 13px; font-weight: 700;
      background: var(--bg); color: var(--text-muted);
    }
    .badge.active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

    /* ===== Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Sticky Layout) ===== */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: separate; /* Required for sticky */
      border-spacing: 0;
      min-width: 800px;
    }
    
    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    th {
      background: #f1f5f9;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨) */
    th:first-child, td:first-child {
      position: sticky;
      right: 0;
      z-index: 10;
      background: var(--surface);
      border-left: 2px solid var(--border); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø«Ø¨Øª */
      font-weight: 700;
      text-align: right;
      min-width: 110px;
      padding-right: 16px;
    }
    th:first-child { background: #f1f5f9; z-index: 20; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙÙˆÙ */
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background-color: #f8fafc; }
    
    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ */
    .rank-1 td:first-child { border-right: 4px solid var(--gold); }
    .rank-last td:first-child { border-right: 4px solid var(--warn); }
    
    /* Inputs Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .score-input {
      width: 60px !important;
      padding: 8px !important;
      text-align: center !important;
      border-color: #cbd5e1 !important;
      background: #f8fafc !important;
    }
    .score-input:focus {
      background: #fff !important;
      border-color: var(--primary) !important;
      transform: scale(1.1);
    }
    /* Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø·Ø© (Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©) */
    .current-round-col {
      background: #eff6ff !important;
    }

    /* ===== Modal & Toast ===== */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none; align-items: center; justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }
    .modal {
      background: var(--surface);
      width: 90%; max-width: 400px;
      padding: 32px 24px;
      border-radius: 24px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      transform: scale(0.9);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes popIn { to { transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .toast {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1e293b; color: #fff;
      padding: 12px 24px;
      border-radius: 99px;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* ===== Responsive Tweaks ===== */
    @media (max-width: 640px) {
      .header h1 { font-size: 22px; }
      .controls-grid { grid-template-columns: 1fr 1fr; }
      #roomCode { grid-column: span 2; }
      #playerName { grid-column: span 2; }
      .card { padding: 16px; border-radius: 12px; }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>

  <div class="container">
    
    <div class="header">
      <h1>ğŸ† ØªÙ† ÙÙŠØ² â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h1>
      <p>Ù„ÙˆØ­Ø© Ù†ØªØ§Ø¦Ø¬ ØªÙØ§Ø¹Ù„ÙŠØ© â€¢ Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</p>
    </div>

    <div class="card">
      <div class="room-header">
        <div id="roomStatus" class="badge">ØºÙŠØ± Ù…ØªØµÙ„</div>
        
        <div id="adminControls" style="display:none; width: 100%;">
          <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:8px; border-radius:12px; margin-top:10px;">
            <button id="prevRound" type="button" class="btn-ghost" style="padding:8px 12px">â® Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <span style="font-weight:bold; color:var(--primary)">Ø¬ÙˆÙ„Ø© <span id="roundBadge" style="font-size:1.2em">1</span> / 10</span>
            <button id="nextRound" type="button" class="btn-ghost" style="padding:8px 12px">Ø§Ù„ØªØ§Ù„ÙŠ â¯</button>
          </div>
        </div>
        
        <div id="viewerControls" style="display:none; width: 100%; text-align:center; margin-top:10px;">
          <span class="badge active" style="font-size:14px">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b id="roundBadgeView" style="margin:0 4px">1</b></span>
        </div>
      </div>

      <div class="controls-grid">
        <input id="roomCode" type="text" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (6 Ø£Ø­Ø±Ù)">
        <button id="createRoom" type="button" class="btn-success">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
        <button id="joinRoom" type="button" class="btn-primary">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©</button>
      </div>
    </div>

    <div class="card">
      <div class="controls-grid" style="margin-bottom: 20px;">
        <input id="playerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
        <button id="addPlayer" type="button" class="btn-primary">ï¼‹ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="calc" type="button" class="btn-ghost" style="flex:1">ğŸ“Š Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        <button id="randomCard" type="button" class="btn-ghost" style="flex:1">ğŸ² SKIP</button>
        <button id="clearAll" type="button" class="btn-danger" style="display:none; flex:1">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>

    <div class="card" style="padding:0; overflow:hidden; border:none; background:transparent; box-shadow:none;">
      <div class="table-container">
        <table id="playersTable">
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="skipBackdrop" class="modal-backdrop">
    <div class="modal">
      <div style="font-size:48px; margin-bottom:10px;">ğŸ²</div>
      <h3 style="margin:0; color:var(--text-muted)">ØµØ§Ø­Ø¨ Ø¨Ø·Ø§Ù‚Ø© SKIP Ù‡Ùˆ</h3>
      <h2 id="skipPlayerName" style="margin:16px 0; font-size:32px; color:var(--primary); font-weight:800"></h2>
      <button id="closeSkip" type="button" class="btn-primary" style="width:100%">Ù…Ø¨Ø±ÙˆÙƒ Ø¹Ù„ÙŠÙƒ</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===== Firebase Setup ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC5Dh7bJzPqLaZl4djKCgpzaHHSeeD1aHU",
  authDomain: "phaseten-435bf.firebaseapp.com",
  projectId: "phaseten-435bf",
  storageBucket: "phaseten-435bf.firebasestorage.app",
  messagingSenderId: "780298483879",
  appId: "1:780298483879:web:6b6627e673d4808e098382",
  measurementId: "G-58E5DVZHZ6"
};
try{ firebase.initializeApp(firebaseConfig); }catch(e){}
const db = firebase.firestore();

/* ===== Logic ===== */
const ROUNDS = 10;
const DEBOUNCE_MS = 700;
let myUid = null;
let roomRef = null;
let roomUnsub = null, playersUnsub = null;
let roomOwner = null;
let currentRound = 1;
const timers = new Map();

// Auth
firebase.auth().onAuthStateChanged(async u=>{
  if(!u){ try{ await firebase.auth().signInAnonymously(); }catch(e){ console.error(e); } }
  else { myUid = u.uid; document.getElementById('roomStatus').textContent = 'Ø£Ù†Øª Ù…ØªØµÙ„'; }
});

function toast(m){ 
  const t=document.getElementById('toast'); 
  t.textContent=m; t.classList.add('show'); 
  setTimeout(()=>t.classList.remove('show'), 2500); 
}

/* ===== UI Builders ===== */
function buildHeader(isAdmin){
  const thead = document.getElementById('theadRow');
  thead.innerHTML='';
  
  // Player Column
  const thName = document.createElement('th'); 
  thName.textContent='Ø§Ù„Ù„Ø§Ø¹Ø¨'; 
  thead.appendChild(thName);

  // Rounds Columns
  for(let i=1; i<=ROUNDS; i++){
    const th = document.createElement('th');
    th.textContent = i;
    // ØªÙ…ÙŠÙŠØ² Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    if(i === currentRound) {
        th.style.color = 'var(--primary)';
        th.style.borderBottom = '2px solid var(--primary)';
    }
    thead.appendChild(th);
  }

  // Stats Columns
  const thTotal = document.createElement('th'); thTotal.textContent='Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'; thead.appendChild(thTotal);
  const thRank = document.createElement('th'); thRank.textContent='Ø§Ù„Ù…Ø±ÙƒØ²'; thead.appendChild(thRank);
  
  if(isAdmin){ 
    const thDel = document.createElement('th'); 
    thDel.textContent='Ø¥Ø¬Ø±Ø§Ø¡'; 
    thead.appendChild(thDel); 
  }
}

function total(arr){ return (arr||[]).reduce((s,v)=>s+(Number.isFinite(v)?v:0),0); }

function drawTable(players, isAdmin){
  const arr = players.map(p=>({...p, total: total(p.scores||[]) }));
  arr.sort((a,b)=> a.total - b.total);
  
  let rank=1;
  for(let i=0;i<arr.length;i++){
    if(i>0 && arr[i].total===arr[i-1].total) arr[i].rank=arr[i-1].rank; else arr[i].rank=rank;
    rank++;
  }
  const worst = arr.length? arr[arr.length-1].total : null;

  const body = document.getElementById('playersBody'); body.innerHTML='';
  
  arr.forEach(p=>{
    const tr=document.createElement('tr');
    if(p.rank===1) tr.classList.add('rank-1');
    if(p.total===worst && arr.length > 1) tr.classList.add('rank-last');

    // 1. Ø§Ù„Ø§Ø³Ù…
    const tdName=document.createElement('td'); 
    tdName.textContent=p.name||'â€”'; 
    // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ø£ÙˆÙ„
    if(p.rank===1) tdName.innerHTML += ' <span style="color:var(--gold)">ğŸ‘‘</span>';
    tr.appendChild(tdName);

    // 2. Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
    for(let r=0;r<ROUNDS;r++){
      const td=document.createElement('td');
      // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·
      if(r === (currentRound - 1)) td.classList.add('current-round-col');

      if(r === (currentRound-1)){
        const inp=document.createElement('input');
        inp.className = 'score-input';
        inp.type='number'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; 
        inp.placeholder='-';
        inp.value = (p.scores && p.scores[r]!=null) ? p.scores[r] : '';
        
        if(p.uid !== myUid) {
            inp.disabled = true;
            inp.style.opacity = '0.5';
        }

        // Logic Save
        const key = p.id+':'+r;
        const saveNow = async ()=>{
          try{
            const v = inp.value===''? null : Number(inp.value);
            const ns = Array.isArray(p.scores)? [...p.scores] : Array(ROUNDS).fill(null);
            ns[r] = v;
            await roomRef.collection('players').doc(p.id).update({
              scores: ns, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            inp.style.borderColor = 'var(--accent)'; // visual feedback
            setTimeout(()=> inp.style.borderColor = '', 1000);
          }catch(err){ console.error(err); toast('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸'); }
        };

        inp.addEventListener('input', ()=>{
          if(inp.disabled) return;
          if(timers.has(key)) clearTimeout(timers.get(key));
          timers.set(key, setTimeout(saveNow, DEBOUNCE_MS));
        });
        inp.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'){ e.preventDefault(); inp.blur(); }
        });
        inp.addEventListener('blur', ()=>{
            if(timers.has(key)){ clearTimeout(timers.get(key)); timers.delete(key); saveNow(); }
        });

        td.appendChild(inp);
      } else {
        td.textContent = (p.scores && p.scores[r]!=null)? p.scores[r] : '';
        td.style.color = '#94a3b8';
      }
      tr.appendChild(td);
    }

    // 3. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const tdTotal=document.createElement('td'); 
    tdTotal.style.fontWeight='bold';
    tdTotal.textContent=total(p.scores||[]); 
    tr.appendChild(tdTotal);

    // 4. Ø§Ù„ØªØ±ØªÙŠØ¨
    const tdRank=document.createElement('td');
    let rBadge = `<span class="badge">${p.rank}</span>`;
    if(p.rank===1) rBadge = `<span class="badge" style="background:#fef3c7; color:#b45309">Ø§Ù„Ø£ÙˆÙ„</span>`;
    else if(p.total===worst && arr.length > 1) rBadge = `<span class="badge" style="background:#ffe4e6; color:#be123c">ğŸ’©</span>`;
    tdRank.innerHTML = rBadge;
    tr.appendChild(tdRank);

    // 5. Ø­Ø°Ù
    if(isAdmin){
      const tdDel=document.createElement('td');
      const btn=document.createElement('button'); 
      btn.textContent='Ã—'; 
      btn.style.cssText = 'padding:4px 8px; background:#fee2e2; color:#ef4444; border-radius:6px; font-size:16px;';
      btn.onclick=async (e)=>{ if(confirm('Ø­Ø°ÙØŸ')) await roomRef.collection('players').doc(p.id).delete(); };
      tdDel.appendChild(btn); tr.appendChild(tdDel);
    }

    body.appendChild(tr);
  });
}

/* ===== Room Logic ===== */
function subscribeToRoom(code){
  if(roomUnsub) roomUnsub(); if(playersUnsub) playersUnsub();
  roomRef = db.collection('rooms').doc(code);

  roomUnsub = roomRef.onSnapshot(doc=>{
    const data = doc.data() || {};
    if(!doc.exists) { document.getElementById('roomStatus').textContent='Ø§Ù†ØªÙ‡Øª Ø§Ù„ØºØ±ÙØ©'; return; }

    roomOwner = data.owner || null;
    currentRound = Math.min(ROUNDS, Math.max(1, data.currentRound || 1));

    const isAdmin = (myUid && myUid===roomOwner);
    document.getElementById('adminControls').style.display = isAdmin? 'block':'none';
    document.getElementById('viewerControls').style.display = isAdmin? 'none':'block';
    
    document.getElementById('roundBadge').textContent = currentRound;
    document.getElementById('roundBadgeView').textContent = currentRound;

    buildHeader(isAdmin);
    
    const statusEl = document.getElementById('roomStatus');
    statusEl.textContent = 'ØºØ±ÙØ©: ' + code;
    statusEl.classList.add('active');
    
    document.getElementById('clearAll').style.display = isAdmin? 'block':'none';
  });

  playersUnsub = roomRef.collection('players').orderBy('createdAt').onSnapshot(snap=>{
    const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
    drawTable(rows, myUid===roomOwner);
  });
}

/* ===== Buttons Logic ===== */
document.getElementById('createRoom').onclick = async (e)=>{
  e.preventDefault();
  const code = Math.random().toString(36).slice(2,8).toUpperCase();
  try{
    await db.collection('rooms').doc(code).set({
      owner: (firebase.auth().currentUser?.uid) || null,
      currentRound: 1,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('roomCode').value = code;
    subscribeToRoom(code);
    toast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©');
  }catch(e){ toast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'); }
};

document.getElementById('joinRoom').onclick = async (e)=>{
  e.preventDefault();
  const code = (document.getElementById('roomCode').value||'').trim().toUpperCase();
  if(!code) return toast('âš ï¸ Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
  try{
    const doc = await db.collection('rooms').doc(code).get();
    if(!doc.exists) return toast('ğŸš« Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    subscribeToRoom(code);
    toast('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„');
  }catch(e){ toast('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
};

// Round Controls
document.getElementById('prevRound').onclick = ()=> changeRound(-1);
document.getElementById('nextRound').onclick = ()=> changeRound(1);

async function changeRound(delta){
  if(myUid!==roomOwner) return;
  const newR = Math.min(ROUNDS, Math.max(1, currentRound + delta));
  try{ await roomRef.update({ currentRound:newR }); }catch(e){}
}

// Add Player
document.getElementById('addPlayer').onclick = async ()=>{
  if(!roomRef) return toast('âš ï¸ Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§');
  const nameInp = document.getElementById('playerName');
  const name = nameInp.value.trim();
  if(!name) return toast('âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…');
  try{
    await roomRef.collection('players').add({
      name, uid: myUid, scores:Array(ROUNDS).fill(null),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    nameInp.value='';
    toast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© '+name);
  }catch(e){ toast('âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ©'); }
};

// Calc Logic
document.getElementById('calc').onclick = async ()=>{
  if(!roomRef) return;
  const snap = await roomRef.collection('players').get();
  const arr=[]; snap.forEach(d=> arr.push(d.data()));
  const totals = arr.map(p=>({name:p.name, t: total(p.scores)})).sort((a,b)=>a.t-b.t);
  
  if(!totals.length) return;
  const best = totals[0].t;
  const worst = totals[totals.length-1].t;
  
  const winners = totals.filter(x=>x.t===best).map(x=>x.name).join(' Ùˆ ');
  toast(`ğŸ‘‘ Ø§Ù„Ù…ØªØµØ¯Ø±: ${winners}`);
};

// Random SKIP
const modal = document.getElementById('skipBackdrop');
document.getElementById('closeSkip').onclick = ()=> modal.style.display='none';
modal.onclick = (e)=> { if(e.target===modal) modal.style.display='none'; }

document.getElementById('randomCard').onclick = async ()=>{
  if(!roomRef) return toast('âš ï¸ Ø§Ø¯Ø®Ù„ ØºØ±ÙØ©');
  const snap = await roomRef.collection('players').get();
  const arr = []; snap.forEach(d=>arr.push(d.data()));
  if(!arr.length) return toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†');
  
  const winner = arr[Math.floor(Math.random()*arr.length)];
  document.getElementById('skipPlayerName').textContent = winner.name;
  modal.style.display='flex';
};

// Clear All
document.getElementById('clearAll').onclick = async ()=>{
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ')) return;
  const snap = await roomRef.collection('players').get();
  const batch = db.batch();
  snap.forEach(d=> batch.delete(d.ref));
  await batch.commit();
  toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ù…Ø³Ø­');
};

// Init
buildHeader(false);
</script>
</body>
</html>
