<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <title>ØªÙ† ÙÙŠØ² â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===== CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ===== */
    :root {
      --primary: #2563eb; --primary-light: #eff6ff;
      --accent: #10b981; --warn: #f43f5e; --gold: #f59e0b;
      --whatsapp: #25D366; /* Ù„ÙˆÙ† ÙˆØ§ØªØ³Ø§Ø¨ */
      --bg: #f1f5f9; --surface: #ffffff;
      --text: #0f172a; --border: #cbd5e1;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text);
      margin: 0; padding: 16px; padding-bottom: 120px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card {
      background: var(--surface); border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .header h1 { margin: 0; font-size: 24px; color: var(--primary); font-weight: 800; text-align: center; }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .status-bar { display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 12px; }
    .badge { background: #e2e8f0; padding: 6px 12px; border-radius: 8px; font-size: 14px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; cursor: pointer;}
    .badge.active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      flex: 1; padding: 12px; border: none; border-radius: 10px;
      font-family: inherit; font-weight: 700; cursor: pointer; transition: 0.2s;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:active { transform: scale(0.96); }
    .btn-blue { background: var(--primary); color: #fff; }
    .btn-green { background: var(--accent); color: #fff; }
    .btn-red { background: var(--warn); color: #fff; }
    .btn-ghost { background: var(--primary-light); color: var(--primary); }
    .btn-wa { background: var(--whatsapp); color: #fff; width: 100%; margin-top: 5px; } /* Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ */
    
    /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    input {
      width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border);
      font-family: inherit; font-size: 16px; outline: none; text-align: center;
    }
    input:focus { border-color: var(--primary); background: #fff; }
    /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø³Ù‡Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }


    /* ===== Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù… (Sticky) ===== */
    .table-wrap { overflow-x: auto; border-radius: 12px; background: #fff; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
    
    th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
    th { background: #f8fafc; font-weight: 700; font-size: 14px; }
    
    /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø§Ø³Ù…) */
    th:first-child, td:first-child {
      position: sticky; right: 0; z-index: 10;
      background: var(--surface); border-left: 2px solid #e2e8f0;
      min-width: 100px; font-weight: 700;
    }
    th:first-child { z-index: 20; background: #f8fafc; }
    
    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù†Ø´Ø· */
    .col-active { background-color: #eff6ff !important; border-left: 1px dashed #bfdbfe; border-right: 1px dashed #bfdbfe; }
    th.col-active { color: var(--primary); border-bottom: 3px solid var(--primary); }

    /* Ø§Ù†Ø¨ÙˆØª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª */
    .score-inp { width: 60px; padding: 6px; font-weight: 700; }
    
    /* Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ */
    .rank-1 td:first-child { border-right: 4px solid var(--gold); }
    .rank-last td:first-child { border-right: 4px solid var(--warn); }

    /* ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø§Ù„Ø¬ÙˆÙ„Ø§Øª */
    .round-control {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      background: #f8fafc; padding: 8px; border-radius: 12px; margin-top: 10px;
    }
    .round-txt { font-size: 18px; font-weight: 800; color: var(--primary); }

    /* Toast & Modal */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: #1e293b; color: #fff; padding: 10px 20px; border-radius: 50px;
      opacity: 0; transition: 0.3s; z-index: 999; pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000;
      display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px);
    }
    .modal { background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }

  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>ğŸ† ØªÙ† ÙÙŠØ²</h1>
    </div>

    <div class="card">
      <div class="status-bar">
        <div id="roomStatusContainer" style="display:none; width:100%; text-align:center;">
          <div class="badge active" onclick="copyLink()">
            <span style="font-size:1.2em">ÙƒÙˆØ¯: </span>
            <span id="roomCodeDisplay" style="font-size:1.4em; letter-spacing:2px; font-family:monospace"></span>
            <span style="font-size:1.2em">ğŸ“‹</span>
          </div>
          <div>
             <button id="shareWaBtn" class="btn-wa" onclick="shareWhatsapp()">
               <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</span> ğŸ’¬
             </button>
          </div>
        </div>
        
        <span id="viewerRound" class="badge" style="display:none; background:#eff6ff; color:#1e40af">Ø§Ù„Ø¬ÙˆÙ„Ø© 1</span>
      </div>

      <div id="adminPanel" style="display:none">
        <div class="round-control">
          <button onclick="changeRound(-1)" class="btn-ghost">â®</button>
          <span class="round-txt">Ø¬ÙˆÙ„Ø© <span id="roundNum">1</span></span>
          <button onclick="changeRound(1)" class="btn-ghost">â¯</button>
        </div>
      </div>

      <div id="loginForm" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:16px;">
        <input id="roomCodeInput" type="number" pattern="[0-9]*" inputmode="numeric" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ø£Ø±Ù‚Ø§Ù…)" style="grid-column: span 2; font-size:18px; letter-spacing:1px;">
        <button id="createBtn" class="btn-green">Ø¥Ù†Ø´Ø§Ø¡</button>
        <button id="joinBtn" class="btn-blue">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; gap:8px; margin-bottom:12px;">
        <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
        <button id="addBtn" class="btn-blue" style="flex:0 0 80px">ï¼‹</button>
      </div>
      <div class="btn-group">
        <button onclick="calcResult()" class="btn-ghost">ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button onclick="randomSkip()" class="btn-ghost">ğŸ² SKIP</button>
        <button id="clearBtn" onclick="clearAll()" class="btn-red" style="display:none">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>

    <div class="card" style="padding:0; overflow:hidden; border:0;">
      <div class="table-wrap">
        <table id="mainTable">
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="modal" class="modal-overlay">
    <div class="modal">
      <div style="font-size:50px">ğŸ²</div>
      <h3>ØµØ§Ø­Ø¨ Ø§Ù„Ø³ÙƒÙŠØ¨</h3>
      <h2 id="modalName" style="color:var(--primary); font-size:30px"></h2>
      <button onclick="document.getElementById('modal').style.display='none'" class="btn-blue" style="width:100%">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC5Dh7bJzPqLaZl4djKCgpzaHHSeeD1aHU",
  authDomain: "phaseten-435bf.firebaseapp.com",
  projectId: "phaseten-435bf",
  storageBucket: "phaseten-435bf.firebasestorage.app",
  messagingSenderId: "780298483879",
  appId: "1:780298483879:web:6b6627e673d4808e098382"
};
try{ firebase.initializeApp(firebaseConfig); }catch(e){}
const db = firebase.firestore();

/* ===== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Global State) ===== */
let state = {
  round: 1,
  players: [],
  owner: null,
  me: null,
  roomCode: null
};
let roomRef = null;
const ROUNDS = 10;
const timers = new Map();

// Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„
firebase.auth().onAuthStateChanged(async u=>{
  if(!u) await firebase.auth().signInAnonymously();
  else state.me = u.uid;
});

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2000);
}

/* ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ===== */
function checkUrlForRoom() {
  const params = new URLSearchParams(window.location.search);
  const roomParam = params.get('room');
  if(roomParam) {
    document.getElementById('roomCodeInput').value = roomParam;
    document.getElementById('roomCodeInput').style.borderColor = 'var(--accent)';
    toast('âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯');
  }
}

function updateUrl(code) {
  const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + code;
  window.history.pushState({path:newUrl},'',newUrl);
}

function shareWhatsapp() {
  if(!state.roomCode) return;
  const url = window.location.href;
  const text = `ÙŠØ§Ù„Ø§ Ù†Ù„Ø¹Ø¨! ğŸ†\nØ§Ø¯Ø®Ù„ Ø³Ø¬Ù„ Ù†ØªÙŠØ¬ØªÙƒ Ù‡Ù†Ø§:\n${url}\n\nÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: *${state.roomCode}*`;
  window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function copyLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!'));
}

/* ===== Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Render Engine) ===== */
function renderApp() {
  const isAdmin = (state.me && state.me === state.owner);
  const inRoom = !!state.roomCode;
  
  // 1. ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
  document.getElementById('loginForm').style.display = inRoom ? 'none' : 'grid';
  document.getElementById('roomStatusContainer').style.display = inRoom ? 'block' : 'none';

  // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØµÙØ­
  if(inRoom) {
      document.getElementById('roomCodeDisplay').textContent = state.roomCode;
      updateUrl(state.roomCode);
  }

  // 2. ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
  document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
  document.getElementById('viewerRound').style.display = (!isAdmin && inRoom) ? 'inline-flex' : 'none';
  document.getElementById('clearBtn').style.display = isAdmin ? 'block' : 'none';
  
  document.getElementById('roundNum').textContent = state.round;
  document.getElementById('viewerRound').textContent = 'Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ' + state.round;

  // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
  const thead = document.getElementById('tableHead');
  thead.innerHTML = '<th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>';
  for(let i=1; i<=ROUNDS; i++) {
    const th = document.createElement('th');
    th.textContent = i;
    if(i === state.round) th.className = 'col-active';
    thead.appendChild(th);
  }
  thead.innerHTML += '<th>Ù…Ø¬Ù…ÙˆØ¹</th><th>#</th>';
  if(isAdmin) thead.innerHTML += '<th>Ã—</th>';

  // 4. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
  const data = state.players.map(p => {
    const sum = (p.scores||[]).reduce((a,b)=>a+(Number(b)||0),0);
    return { ...p, sum };
  });
  data.sort((a,b) => a.sum - b.sum);

  // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨
  let rank = 1;
  const worstScore = data.length ? data[data.length-1].sum : -1;
  
  // 5. Ø±Ø³Ù… Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  data.forEach((p, index) => {
    if(index > 0 && p.sum === data[index-1].sum) p.rank = data[index-1].rank;
    else p.rank = rank;
    rank++;

    const tr = document.createElement('tr');
    if(p.rank === 1) tr.className = 'rank-1';
    if(p.sum === worstScore && data.length > 1) tr.className = 'rank-last';

    // Ø§Ù„Ø§Ø³Ù…
    let nameHtml = p.name;
    if(p.rank === 1) nameHtml += ' <span style="color:var(--gold)">ğŸ‘‘</span>';
    const tdName = document.createElement('td'); tdName.innerHTML = nameHtml; tr.appendChild(tdName);

    // Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
    for(let r=0; r<ROUNDS; r++) {
      const td = document.createElement('td');
      if(r === state.round - 1) {
        td.className = 'col-active';
        
        const inp = document.createElement('input');
        inp.type = 'number'; inp.className = 'score-inp';
        inp.placeholder = '-';
        inp.value = (p.scores && p.scores[r] != null) ? p.scores[r] : '';

        const canEdit = (p.uid === state.me) || isAdmin;
        if(!canEdit) inp.disabled = true;

        const key = `${p.id}-${r}`;
        inp.oninput = () => {
          if(timers.has(key)) clearTimeout(timers.get(key));
          timers.set(key, setTimeout(() => saveScore(p.id, r, inp.value), 600));
        };
        inp.onkeydown = (e) => { if(e.key === 'Enter') inp.blur(); };
        inp.onblur = () => saveScore(p.id, r, inp.value);

        td.appendChild(inp);
      } else {
        td.textContent = (p.scores && p.scores[r] != null) ? p.scores[r] : '';
        td.style.color = '#94a3b8';
      }
      tr.appendChild(td);
    }

    // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const tdSum = document.createElement('td'); 
    tdSum.style.fontWeight='bold'; tdSum.textContent = p.sum; tr.appendChild(tdSum);

    // Ø§Ù„ØªØ±ØªÙŠØ¨
    const tdRank = document.createElement('td');
    if(p.sum === worstScore && data.length > 1) tdRank.innerHTML = '<span class="badge" style="background:#fee2e2; color:#ef4444">ğŸ’©</span>';
    else tdRank.innerHTML = `<span class="badge">${p.rank}</span>`;
    tr.appendChild(tdRank);

    // Ø­Ø°Ù
    if(isAdmin) {
      const tdDel = document.createElement('td');
      tdDel.innerHTML = `<button onclick="deletePlayer('${p.id}')" style="background:#fee2e2; color:red; padding:4px 8px">Ã—</button>`;
      tr.appendChild(tdDel);
    }

    tbody.appendChild(tr);
  });
}

/* ===== Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Actions) ===== */

// 1. Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
async function saveScore(pid, roundIdx, val) {
  if(!roomRef) return;
  const num = val === '' ? null : Number(val);
  const player = state.players.find(p => p.id === pid);
  if(player) {
    const newScores = [...(player.scores || Array(ROUNDS).fill(null))];
    newScores[roundIdx] = num;
    try {
      await roomRef.collection('players').doc(pid).update({ scores: newScores });
    } catch(e) { console.error(e); }
  }
}

// 2. ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©
async function changeRound(delta) {
  if(state.me !== state.owner) return;
  const newR = Math.min(ROUNDS, Math.max(1, state.round + delta));
  if(newR !== state.round) {
    await roomRef.update({ currentRound: newR });
  }
}

// 3. Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØºØ±ÙØ©
function subscribe(code) {
  if(roomRef) {} 
  roomRef = db.collection('rooms').doc(code);
  state.roomCode = code;

  roomRef.onSnapshot(doc => {
    if(!doc.exists) { 
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ùˆ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
        state.roomCode = null; roomRef = null;
        renderApp();
        return toast('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); 
    }
    const d = doc.data();
    state.owner = d.owner;
    
    const oldRound = state.round;
    state.round = d.currentRound || 1;
    
    renderApp();

    if(state.round !== oldRound) {
       setTimeout(() => {
         const active = document.querySelector('.col-active input');
         if(active) active.scrollIntoView({behavior:'smooth', inline:'center'});
       }, 500);
    }
  });

  roomRef.collection('players').onSnapshot(snap => {
    state.players = [];
    snap.forEach(d => state.players.push({ id: d.id, ...d.data() }));
    renderApp();
  });
}

/* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===== */

// Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (ØªØ¹Ø¯ÙŠÙ„: ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ 6 Ø®Ø§Ù†Ø§Øª)
document.getElementById('createBtn').onclick = async () => {
  const code = Math.floor(100000 + Math.random() * 900000).toString(); // ÙƒÙˆØ¯ Ø±Ù‚Ù…ÙŠ
  await db.collection('rooms').doc(code).set({
    owner: state.me, currentRound: 1, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø§Ù†Ø¨ÙˆØª Ù„Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø³ØªØªØºÙŠØ±
  subscribe(code);
  toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ğŸš€');
};

// Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
document.getElementById('joinBtn').onclick = async () => {
  const code = document.getElementById('roomCodeInput').value.trim(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙŠØ¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  if(!code) return toast('Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯');
  const d = await db.collection('rooms').doc(code).get();
  if(d.exists) { subscribe(code); toast('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
  else toast('Ø§Ù„ÙƒÙˆØ¯ ØºÙ„Ø·!');
};

document.getElementById('addBtn').onclick = async () => {
  if(!roomRef) return toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹');
  const n = document.getElementById('pName').value.trim();
  if(!n) return toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…');
  await roomRef.collection('players').add({
    name: n, uid: state.me, scores: Array(ROUNDS).fill(null),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('pName').value = '';
};

// Ø£Ø¯ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
function deletePlayer(id) {
  if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ')) roomRef.collection('players').doc(id).delete();
}
async function clearAll() {
  if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ')) {
    const snap = await roomRef.collection('players').get();
    const batch = db.batch();
    snap.forEach(d => batch.delete(d.ref));
    await batch.commit();
    toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­');
  }
}
function calcResult() {
  const sorted = [...state.players].sort((a,b) => {
     const sA = (a.scores||[]).reduce((x,y)=>x+(y||0),0);
     const sB = (b.scores||[]).reduce((x,y)=>x+(y||0),0);
     return sA - sB;
  });
  if(sorted.length) toast(`Ø§Ù„Ø£ÙˆÙ„: ${sorted[0].name}`);
}
function randomSkip() {
  if(!state.players.length) return toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ†');
  const r = state.players[Math.floor(Math.random()*state.players.length)];
  document.getElementById('modalName').textContent = r.name;
  document.getElementById('modal').style.display = 'flex';
}

// ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
window.onload = checkUrlForRoom;

// ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
renderApp();
</script>
</body>
</html>
