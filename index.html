<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ØªÙ† ÙÙŠØ² â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ø¥Ø¯Ø§Ø±Ø© Ø¬ÙˆÙ„Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†)</title>
  <style>
    :root{ --bg:#f3f7ff; --ink:#0b2340; --muted:#6b7a90; --card:#fff; --shadow:0 10px 28px rgba(11,35,64,.12);
           --primary:#2563eb; --accent:#22c55e; --warn:#ef4444; --gold:#fbbf24; --silver:#c0c7d1; }
    *{box-sizing:border-box}
    body{font-family:Tahoma,Arial,sans-serif;background:linear-gradient(180deg,#f0f6ff 0%, #f8fbff 40%, #ffffff 100%);min-height:100vh;margin:0;padding:16px;color:var(--ink)}
    .container{max-width:1100px;margin:0 auto; padding-bottom:110px;}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    .hero{padding:18px 20px;background:linear-gradient(90deg,#e8f0ff,#fff);display:flex;align-items:center;gap:14px;border:1px solid #e6eefc}
    .badge{background:#eef4ff;color:#234; padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #dbe7ff}
    h1{font-size:22px;margin:6px 0}
    p{margin:0;color:var(--muted)}
    input, button{font-size:16px}
    input[type=text], input[type=number]{padding:12px 14px;border-radius:12px;border:1px solid #d8e4f5;background:#fafcff;outline:none;transition:.2s}
    input[type=number]{text-align:left; direction:ltr;width:90px}
    .toolbar, .roombar, .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .roombar input{max-width:180px}
    button{padding:12px 16px;border-radius:12px;border:0;background:var(--primary);color:#fff;cursor:pointer;transition:.06s;box-shadow:0 6px 16px rgba(37,99,235,.18)}
    button.ghost{background:#eaf2ff;color:#123;border:1px solid #d7e6ff;box-shadow:none}
    button.warn{background:var(--warn)}
    button.good{background:var(--accent)}
    .pill{padding:8px 12px;border-radius:999px;background:#eaf2ff;border:1px solid #d7e6ff;display:inline-flex;gap:8px;align-items:center}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:12px;border:1px solid #e8f1ff}
    table{width:max(950px,100%);border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef4fb;text-align:center;white-space:nowrap}
    tbody tr:nth-child(odd){background:#fcfeff}
    .first{background:linear-gradient(90deg,#fffbeb,#fff4cc); border-inline-start:6px solid var(--gold)}
    .second{background:linear-gradient(90deg,#f7f8fc,#eef2f7); border-inline-start:6px solid var(--silver)}
    .last{background:linear-gradient(90deg,#fff1f2,#ffe4e6); border-inline-start:6px solid var(--warn)}
    .toast{position:fixed;inset-inline:0;bottom:90px;margin:auto;max-width:360px;background:#0b2340;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(12px);pointer-events:none;transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}
    @media (max-width: 640px){
      body{padding:12px}
      .container{padding:0; padding-bottom:120px;}
      .hero{flex-direction:column;align-items:flex-start}
      th,td{padding:8px 6px}
      .roombar input{flex:1;max-width:none}
      .roombar button{flex:1}
    }
  </style>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="card hero">
      <div class="badge">ØªÙ† ÙÙŠØ² â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
      <div>
        <h1>Ù„ÙˆØ­Ø© Ù†Ù‚Ø§Ø· (Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø©)</h1>
        <p>Ø£Ù‚Ù„ Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ùˆ Ø§Ù„ÙØ§Ø¦Ø² ğŸ‘‘ â€” Ø¢Ø®Ø± ØªØ±ØªÙŠØ¨ = Ø§Ù„ÙƒÙˆØ² ğŸª£</p>
      </div>
    </div>

    <!-- Ø§Ù„ØºØ±ÙØ© -->
    <div class="card">
      <div class="roombar">
        <input id="roomCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
        <button id="createRoom" class="good">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
        <button id="joinRoom" class="ghost">Ø¯Ø®ÙˆÙ„</button>
        <div style="flex:1"></div>
        <span id="roomStatus" class="badge">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>
      <!-- ØªØ­ÙƒÙ… Ø§Ù„Ø¬ÙˆÙ„Ø© (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) -->
      <div id="adminControls" style="margin-top:10px; display:none;">
        <span class="pill">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b id="roundBadge">1 / 10</b></span>
        <button id="prevRound" class="ghost">âŸµ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
        <button id="nextRound" class="ghost">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© âŸ¶</button>
      </div>
      <!-- Ù„Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (ØºÙŠØ± Ø§Ù„Ø£Ø¯Ù…Ù†) Ù…Ø¬Ø±Ø¯ Ø¹Ø±Ø¶ -->
      <div id="viewerControls" style="margin-top:10px; display:none;">
        <span class="pill">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b id="roundBadgeView">1 / 10</b></span>
      </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ -->
    <div class="card">
      <div class="row">
        <input id="playerName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
        <button id="addPlayer" class="good">+ Ø£Ø¶Ù Ù„Ø§Ø¹Ø¨</button>
        <button id="calc" class="ghost">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        <button id="clearAll" class="warn" style="display:none;">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø£Ø¯Ù…Ù†)</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="table-wrap">
        <table id="playersTable">
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===== Firebase config (Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC5Dh7bJzPqLaZl4djKCgpzaHHSeeD1aHU",
  authDomain: "phaseten-435bf.firebaseapp.com",
  projectId: "phaseten-435bf",
  storageBucket: "phaseten-435bf.firebasestorage.app",
  messagingSenderId: "780298483879",
  appId: "1:780298483879:web:6b6627e673d4808e098382",
  measurementId: "G-58E5DVZHZ6"
};
try{ firebase.initializeApp(firebaseConfig); }catch(e){}
const db = firebase.firestore();

/* ===== Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ===== */
const ROUNDS = 10;
const DEBOUNCE_MS = 700;                  // â† ØªØ£Ø®ÙŠØ± Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©
let myUid = null;
let roomRef = null;
let roomUnsub = null, playersUnsub = null;
let roomOwner = null;
let currentRound = 1;
const timers = new Map();                 // key = playerId:round

// Auth åŒ¿å
firebase.auth().onAuthStateChanged(async u=>{
  if(!u){ try{ await firebase.auth().signInAnonymously(); }catch(e){ console.error(e); } }
  else { myUid = u.uid; document.getElementById('roomStatus').textContent = 'Ø¬Ø§Ù‡Ø²'; }
});

function toast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }

/* ===== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
function buildHeader(isAdmin){
  const thead = document.getElementById('theadRow');
  thead.innerHTML='';
  const cols = [
    {label:'Ø§Ù„Ù„Ø§Ø¹Ø¨'},
    ...Array.from({length:ROUNDS},(_,i)=>({label:'Ø¬ÙˆÙ„Ø© '+(i+1)})),
    {label:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'}, {label:'Ø§Ù„ØªØ±ØªÙŠØ¨'}
  ];
  cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c.label; thead.appendChild(th); });
  if(isAdmin){ const th=document.createElement('th'); th.textContent='Ø­Ø°Ù'; thead.appendChild(th); }
}

/* ===== Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ===== */
function total(arr){ return (arr||[]).reduce((s,v)=>s+(Number.isFinite(v)?v:0),0); }

/* ===== Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
function drawTable(players, isAdmin){
  // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£ÙƒØ«Ø±
  const arr = players.map(p=>({...p, total: total(p.scores||[]) }));
  arr.sort((a,b)=> a.total - b.total);
  let rank=1;
  for(let i=0;i<arr.length;i++){
    if(i>0 && arr[i].total===arr[i-1].total) arr[i].rank=arr[i-1].rank; else arr[i].rank=rank;
    rank++;
  }
  const worst = arr.length? arr[arr.length-1].total : null;

  const body = document.getElementById('playersBody'); body.innerHTML='';
  arr.forEach(p=>{
    const tr=document.createElement('tr');
    if(p.rank===1) tr.classList.add('first');
    else if(p.rank===2) tr.classList.add('second');
    if(p.total===worst) tr.classList.add('last');

    // Ø§Ù„Ø§Ø³Ù…
    const tdName=document.createElement('td'); tdName.textContent=p.name||'â€”'; tr.appendChild(tdName);

    // Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø§Øª: Ù†Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ØŒ Ù„ÙƒÙ† Ø®Ø§Ù†Ø© "Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©" ÙÙ‚Ø· ÙŠÙƒÙˆÙ† ÙÙŠÙ‡Ø§ input ÙˆÙ…ÙØ¹Ù‘Ù„ Ù„Ùˆ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø·Ø±
    for(let r=0;r<ROUNDS;r++){
      const td=document.createElement('td');
      if(r === (currentRound-1)){
        const inp=document.createElement('input');
        inp.type='number'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; inp.min='0';
        inp.value = (p.scores && p.scores[r]!=null) ? p.scores[r] : '';
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø·Ø±
        if(p.uid !== myUid) inp.disabled = true;

        // ---- Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ø¬Ù„ (debounce) + Enter + blur ----
        const key = p.id+':'+r;
        const saveNow = async ()=>{
          try{
            const v = inp.value===''? null : Number(inp.value);
            const ns = Array.isArray(p.scores)? [...p.scores] : Array(ROUNDS).fill(null);
            ns[r] = v;
            await roomRef.collection('players').doc(p.id).update({
              scores: ns, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }catch(err){ console.error(err); toast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø©: '+err.message); }
        };

        inp.addEventListener('input', ()=>{
          if(inp.disabled) return;
          if(timers.has(key)) clearTimeout(timers.get(key));
          timers.set(key, setTimeout(saveNow, DEBOUNCE_MS));  // ÙŠØ­ÙØ¸ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ®Ù„Øµ ÙƒØªØ§Ø¨Ø©
        });

        inp.addEventListener('keydown', (e)=>{
          if(inp.disabled) return;
          if(e.key==='Enter'){
            e.preventDefault();
            if(timers.has(key)) clearTimeout(timers.get(key));
            saveNow().then(()=> inp.blur());
          }
        });

        inp.addEventListener('blur', ()=>{
          if(inp.disabled) return;
          if(timers.has(key)) { clearTimeout(timers.get(key)); timers.delete(key); }
          saveNow();
        });
        // -----------------------------------------------

        td.appendChild(inp);
      }else{
        td.textContent = (p.scores && p.scores[r]!=null)? p.scores[r] : 'â€”';
      }
      tr.appendChild(td);
    }

    // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    const tdTotal=document.createElement('td'); tdTotal.textContent=total(p.scores||[]); tr.appendChild(tdTotal);

    // Ø§Ù„ØªØ±ØªÙŠØ¨
    const tdRank=document.createElement('td');
    let label = p.rank;
    if(p.rank===1) label='Ø§Ù„Ø£ÙˆÙ„ ğŸ‘‘';
    else if(p.rank===2) label='Ø§Ù„Ø«Ø§Ù†ÙŠ';
    if(p.total===worst) label='Ø§Ù„ÙƒÙˆØ² ğŸª£';
    tdRank.textContent=label; tr.appendChild(tdRank);

    // Ø­Ø°Ù (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
    if(isAdmin){
      const tdDel=document.createElement('td');
      const btn=document.createElement('button'); btn.textContent='Ø­Ø°Ù'; btn.className='ghost';
      btn.onclick=async ()=>{ if(confirm('Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ')){ await roomRef.collection('players').doc(p.id).delete(); } };
      tdDel.appendChild(btn); tr.appendChild(tdDel);
    }

    body.appendChild(tr);
  });
}

/* ===== Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØºØ±ÙØ© ===== */
function subscribeToRoom(code){
  if(roomUnsub) roomUnsub(); if(playersUnsub) playersUnsub();
  roomRef = db.collection('rooms').doc(code);

  roomUnsub = roomRef.onSnapshot(doc=>{
    const data = doc.data() || {};
    roomOwner = data.owner || null;
    currentRound = Math.min(ROUNDS, Math.max(1, data.currentRound || 1));

    // ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†
    const isAdmin = (myUid && myUid===roomOwner);
    document.getElementById('adminControls').style.display = isAdmin? 'block':'none';
    document.getElementById('viewerControls').style.display = isAdmin? 'none':'block';
    document.getElementById('roundBadge').textContent = currentRound+' / '+ROUNDS;
    document.getElementById('roundBadgeView').textContent = currentRound+' / '+ROUNDS;

    buildHeader(isAdmin);
    document.getElementById('roomStatus').textContent = 'ØºØ±ÙØ©: '+code;
    document.getElementById('roomStatus').style.background='#eaffef';
    document.getElementById('roomStatus').style.border='1px solid #b8f0c8';
    document.getElementById('clearAll').style.display = isAdmin? 'inline-block':'none';
  });

  playersUnsub = roomRef.collection('players').orderBy('createdAt').onSnapshot(snap=>{
    const rows=[]; snap.forEach(d=> rows.push({id:d.id, ...d.data()}));
    drawTable(rows, myUid===roomOwner);
  }, err=>{ console.error(err); toast('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: '+err.message); });
}

/* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØºØ±ÙØ© ===== */
document.getElementById('createRoom').onclick = async ()=>{
  const code = Math.random().toString(36).slice(2,8).toUpperCase();
  try{
    await db.collection('rooms').doc(code).set({
      owner: (firebase.auth().currentUser && firebase.auth().currentUser.uid) || null,
      currentRound: 1,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('roomCode').value = code;
    subscribeToRoom(code);
    toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: '+code);
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: '+e.message); }
};

document.getElementById('joinRoom').onclick = async ()=>{
  const code = (document.getElementById('roomCode').value||'').trim().toUpperCase();
  if(!code) return toast('Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
  try{
    const doc = await db.collection('rooms').doc(code).get();
    if(!doc.exists) return toast('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    subscribeToRoom(code);
    toast('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ© '+code);
  }catch(e){ console.error(e); toast('ØªØ¹Ø°Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: '+e.message); }
};

/* ===== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) ===== */
document.getElementById('prevRound').onclick = async ()=>{
  if(myUid!==roomOwner) return;
  const newR = Math.max(1, currentRound-1);
  try{ await roomRef.update({ currentRound:newR }); }catch(e){ toast('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©'); }
};
document.getElementById('nextRound').onclick = async ()=>{
  if(myUid!==roomOwner) return;
  const newR = Math.min(ROUNDS, currentRound+1);
  try{ await roomRef.update({ currentRound:newR }); }catch(e){ toast('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©'); }
};

/* ===== Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ (Ø£ÙŠ Ø­Ø¯ ÙŠØ¶ÙŠÙ Ù†ÙØ³Ù‡ ÙÙ‚Ø·) ===== */
document.getElementById('addPlayer').onclick = async ()=>{
  if(!roomRef) return toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§');
  const name = (document.getElementById('playerName').value||'').trim();
  if(!name) return toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨');
  try{
    await roomRef.collection('players').add({
      name, uid: myUid, scores:Array(ROUNDS).fill(null),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('playerName').value='';
    toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨');
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨: '+e.message); }
};

/* ===== Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø£ÙŠ Ø­Ø¯) ===== */
document.getElementById('calc').onclick = async ()=>{
  if(!roomRef) return toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§');
  try{
    const snap = await roomRef.collection('players').get();
    const arr=[]; snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
    const totals = arr.map(p=>({ name:p.name, uid:p.uid, total: total(p.scores||[]) }))
                      .sort((a,b)=> a.total-b.total);
    const best = totals.length? totals[0].total : null;
    const worst = totals.length? totals[totals.length-1].total : null;
    await roomRef.set({ leaderboard: totals, lastCalcAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    const winners = totals.filter(x=>x.total===best).map(x=>x.name).join('ØŒ ');
    const kooz    = totals.filter(x=>x.total===worst).map(x=>x.name).join('ØŒ ');
    toast(`Ø§Ù„ÙØ§Ø¦Ø²: ${winners} â€” Ø§Ù„ÙƒÙˆØ²: ${kooz}`);
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨: '+e.message); }
};

/* ===== Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) ===== */
document.getElementById('clearAll').onclick = async ()=>{
  if(!roomRef) return;
  if(myUid!==roomOwner) return toast('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·');
  if(!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŸ')) return;
  try{
    const snap = await roomRef.collection('players').get();
    const batch = db.batch();
    snap.forEach(d=> batch.delete(roomRef.collection('players').doc(d.id)));
    await batch.commit();
    toast('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†');
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: '+e.message); }
};

/* ===== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø§ØªØµØ§Ù„) ===== */
buildHeader(false);
</script>

<!-- ===== Firestore Rules Ù„Ù„ØªØ¬Ø±Ø¨Ø© (Ø§Ù†Ø³Ø®Ù‡Ø§ ÙÙŠ Rules) =====
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /rooms/{room} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.owner ||
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['leaderboard','lastCalcAt'])
      );
      allow delete: if false;
    }
    match /rooms/{room}/players/{player} {
      allow read: if true;
      allow create: if request.auth != null &&
                    request.resource.data.uid == request.auth.uid;
      allow update: if request.auth != null && (
        request.auth.uid == get(/databases/$(database)/documents/rooms/$(room)).data.owner ||
        (
          request.auth.uid == resource.data.uid &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['scores','updatedAt'])
        )
      );
      allow delete: if request.auth != null &&
        request.auth.uid == get(/databases/$(database)/documents/rooms/$(room)).data.owner;
    }
  }
}
===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ===== -->
</body>
</html>
