<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <title>ØªÙ† ÙÙŠØ² â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ===== CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ===== */
    :root {
      --primary: #2563eb; --primary-light: #eff6ff;
      --accent: #10b981; --warn: #f43f5e; --gold: #f59e0b;
      --whatsapp: #25D366;
      --bg: #f8fafc; --surface: #ffffff;
      --text: #0f172a; --border: #cbd5e1;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text);
      margin: 0; padding: 16px; padding-bottom: 120px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card {
      background: var(--surface); border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08);
      padding: 16px; margin-bottom: 16px; border: 1px solid var(--border);
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .header h1 { margin: 0; font-size: 26px; color: var(--primary); font-weight: 800; text-align: center; }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© */
    .status-bar { display: flex; flex-direction: column; gap: 12px; align-items: center; margin-bottom: 12px; }
    .badge { 
      background: #e2e8f0; padding: 8px 16px; border-radius: 12px; 
      font-size: 15px; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
    }
    .badge.active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    button {
      flex: 1; padding: 12px; border: none; border-radius: 12px;
      font-family: inherit; font-weight: 700; cursor: pointer; transition: 0.2s;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    }
    button:active { transform: scale(0.96); }
    .btn-blue { background: var(--primary); color: #fff; }
    .btn-green { background: var(--accent); color: #fff; }
    .btn-red { background: var(--warn); color: #fff; }
    .btn-ghost { background: var(--primary-light); color: var(--primary); }
    .btn-wa { background: var(--whatsapp); color: #fff; width: 100%; }
    
    /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    input {
      width: 100%; padding: 12px; border-radius: 12px; border: 2px solid var(--border);
      font-family: inherit; font-size: 16px; outline: none; text-align: center;
      transition: all 0.2s; background: #fff;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
    /* Ø¥Ø®ÙØ§Ø¡ Ø£Ø³Ù‡Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* ===== Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Sticky Column) ===== */
    .table-wrap { overflow-x: auto; border-radius: 12px; background: #fff; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
    
    th, td { padding: 12px 6px; text-align: center; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
    th { background: #f8fafc; font-weight: 700; font-size: 14px; color: #64748b; }
    
    /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨) */
    th:first-child, td:first-child {
      position: sticky; right: 0; z-index: 10;
      background: var(--surface); border-left: 2px solid #e2e8f0;
      min-width: 110px; font-weight: 700;
    }
    th:first-child { z-index: 20; background: #f8fafc; }
    
    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
    .col-active { background-color: #eff6ff !important; border-left: 1px dashed #bfdbfe; border-right: 1px dashed #bfdbfe; }
    th.col-active { color: var(--primary); border-bottom: 3px solid var(--primary); }
    
    /* Inputs Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .score-inp { 
      width: 65px; padding: 8px; font-weight: 700; background: #f8fafc; 
      border: 1px solid #cbd5e1; border-radius: 8px;
    }
    .score-inp:focus { background: #fff; border-color: var(--primary); }

    /* Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ */
    .rank-1 td:first-child { border-right: 5px solid var(--gold); background: #fffbeb; }
    .rank-last td:first-child { border-right: 5px solid var(--warn); background: #fef2f2; }

    /* Toast */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: #0f172a; color: #fff; padding: 12px 24px; border-radius: 50px;
      opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2000;
      font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: #ef4444; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000;
      display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px);
    }
    .modal { background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>ğŸ† ØªÙ† ÙÙŠØ²</h1>
    </div>

    <div class="card">
      
      <div id="roomStatusContainer" class="status-bar" style="display:none;">
        <div class="badge active" onclick="copyLink()">
          <span style="font-size:1.2em">ÙƒÙˆØ¯: </span>
          <span id="roomCodeDisplay" style="font-size:1.6em; letter-spacing:3px; font-family:monospace"></span>
          <span>ğŸ“‹</span>
        </div>
        <button id="shareWaBtn" class="btn-wa" onclick="shareWhatsapp()">
           <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</span> ğŸ’¬
        </button>
        <span id="viewerRound" class="badge" style="display:none; background:#eff6ff; color:#1e40af"></span>
      </div>

      <div id="adminPanel" style="display:none; margin-bottom:16px;">
        <div style="display:flex; justify-content:center; gap:12px; align-items:center; background:#f8fafc; padding:10px; border-radius:12px; border:1px solid #e2e8f0;">
          <button onclick="changeRound(-1)" class="btn-ghost" style="max-width:50px">â®</button>
          <span style="font-weight:800; color:var(--primary); font-size:18px">Ø¬ÙˆÙ„Ø© <span id="roundNum">1</span></span>
          <button onclick="changeRound(1)" class="btn-ghost" style="max-width:50px">â¯</button>
        </div>
      </div>

      <div id="loginForm" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <input id="roomCodeInput" type="number" pattern="[0-9]*" inputmode="numeric" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (6 Ø£Ø±Ù‚Ø§Ù…)" style="grid-column: span 2; font-size:20px; letter-spacing:2px;">
        <button id="createBtn" class="btn-green">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
        <button id="joinBtn" class="btn-blue">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>

    <div id="gameControls" class="card" style="display:none;">
      <div style="display:flex; gap:8px;">
        <input id="pName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯...">
        <button id="addBtn" class="btn-blue" style="flex:0 0 70px; font-size:20px">ï¼‹</button>
      </div>
      <div class="btn-group">
        <button onclick="calcResult()" class="btn-ghost">ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button onclick="randomSkip()" class="btn-ghost">ğŸ² SKIP</button>
        <button id="clearBtn" onclick="clearAll()" class="btn-red" style="display:none">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>

    <div id="tableCard" class="card" style="padding:0; overflow:hidden; border:0; display:none;">
      <div class="table-wrap">
        <table id="mainTable">
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="modal" class="modal-overlay">
    <div class="modal">
      <div style="font-size:50px; margin-bottom:10px">ğŸ²</div>
      <h3 style="margin:0; color:#64748b">ØµØ§Ø­Ø¨ Ø§Ù„Ø³ÙƒÙŠØ¨ Ù‡Ùˆ</h3>
      <h2 id="modalName" style="color:var(--primary); font-size:32px; font-weight:800; margin:15px 0"></h2>
      <button onclick="document.getElementById('modal').style.display='none'" class="btn-blue" style="width:100%">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===== Firebase Config ===== */
// âš ï¸ Ù‡Ø§Ù…: ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ®Øµ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø£Ù†Øª
const firebaseConfig = {
  apiKey: "AIzaSyC5Dh7bJzPqLaZl4djKCgpzaHHSeeD1aHU",
  authDomain: "phaseten-435bf.firebaseapp.com",
  projectId: "phaseten-435bf",
  storageBucket: "phaseten-435bf.firebasestorage.app",
  messagingSenderId: "780298483879",
  appId: "1:780298483879:web:6b6627e673d4808e098382"
};

try{ firebase.initializeApp(firebaseConfig); }catch(e){}
const db = firebase.firestore();

/* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ===== */
let state = { round: 1, players: [], owner: null, me: null, roomCode: null };
let roomRef = null;
const ROUNDS = 10;
const timers = new Map();

// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
firebase.auth().onAuthStateChanged(async u=>{
  if(!u) await firebase.auth().signInAnonymously();
  else state.me = u.uid;
});

function toast(msg, isError = false){
  const t = document.getElementById('toast');
  t.textContent = msg; 
  t.className = isError ? 'toast show error' : 'toast show';
  setTimeout(()=>t.classList.remove('show'), 2500);
}

/* ===== Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ===== */
function checkUrlForRoom() {
  const params = new URLSearchParams(window.location.search);
  const roomParam = params.get('room');
  if(roomParam) {
    document.getElementById('roomCodeInput').value = roomParam;
    toast('âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
  }
}

function updateUrl(code) {
  const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + code;
  window.history.pushState({path:newUrl},'',newUrl);
}

function shareWhatsapp() {
  if(!state.roomCode) return;
  const url = window.location.href;
  const text = `ÙŠØ§Ù„Ø§ Ù†Ù„Ø¹Ø¨! ğŸ†\nØ§Ø¯Ø®Ù„ Ø³Ø¬Ù„ Ù†ØªÙŠØ¬ØªÙƒ Ù‡Ù†Ø§:\n${url}\n\nÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: *${state.roomCode}*`;
  window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function copyLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!'));
}

/* ===== Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Render) ===== */
function renderApp() {
  const isAdmin = (state.me && state.me === state.owner);
  const inRoom = !!state.roomCode;

  // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª
  document.getElementById('loginForm').style.display = inRoom ? 'none' : 'grid';
  document.getElementById('roomStatusContainer').style.display = inRoom ? 'flex' : 'none';
  document.getElementById('gameControls').style.display = inRoom ? 'block' : 'none';
  document.getElementById('tableCard').style.display = inRoom ? 'block' : 'none';

  if(inRoom) {
    document.getElementById('roomCodeDisplay').textContent = state.roomCode;
    updateUrl(state.roomCode);
  }

  // ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†
  document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
  document.getElementById('clearBtn').style.display = isAdmin ? 'block' : 'none';
  
  // Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©
  document.getElementById('roundNum').textContent = state.round;
  const vRound = document.getElementById('viewerRound');
  if(!isAdmin && inRoom) {
      vRound.style.display = 'inline-flex';
      vRound.textContent = 'Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ' + state.round;
  } else {
      vRound.style.display = 'none';
  }

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const thead = document.getElementById('tableHead');
  thead.innerHTML = '<th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>';
  for(let i=1; i<=ROUNDS; i++) {
    const th = document.createElement('th');
    th.textContent = i;
    if(i === state.round) th.className = 'col-active';
    thead.appendChild(th);
  }
  thead.innerHTML += '<th>Ù…Ø¬Ù…ÙˆØ¹</th><th>#</th>';
  if(isAdmin) thead.innerHTML += '<th>Ã—</th>';

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
  const data = state.players.map(p => ({ ...p, sum: (p.scores||[]).reduce((a,b)=>a+(Number(b)||0),0) }));
  data.sort((a,b) => a.sum - b.sum);
  
  let rank = 1;
  const worst = data.length ? data[data.length-1].sum : -1;

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  data.forEach((p, idx) => {
    if(idx > 0 && p.sum === data[idx-1].sum) p.rank = data[idx-1].rank; else p.rank = rank;
    rank++;

    const tr = document.createElement('tr');
    if(p.rank === 1) tr.className = 'rank-1';
    if(p.sum === worst && data.length > 1) tr.className = 'rank-last';

    // Ø§Ù„Ø§Ø³Ù…
    const tdName = document.createElement('td'); 
    tdName.innerHTML = p.rank===1 ? `${p.name} <span style="color:#fbbf24">ğŸ‘‘</span>` : p.name;
    tr.appendChild(tdName);

    // Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
    for(let r=0; r<ROUNDS; r++) {
      const td = document.createElement('td');
      if(r === state.round - 1) {
        td.className = 'col-active';
        const inp = document.createElement('input');
        inp.type = 'number'; inp.pattern = "[0-9]*"; inp.inputMode = "numeric"; // Ù„Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        inp.className = 'score-inp'; 
        inp.placeholder='-';
        inp.value = (p.scores && p.scores[r]!=null) ? p.scores[r] : '';
        
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„ØºÙŠØ± Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ø§Ø³Ù…
        const canEdit = (p.uid === state.me) || isAdmin;
        if(!canEdit) inp.disabled = true;

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­ÙØ¸ (Delay + Immediate on Blur)
        const key = `${p.id}-${r}`;
        inp.oninput = () => {
          if(timers.has(key)) clearTimeout(timers.get(key));
          timers.set(key, setTimeout(() => saveScore(p.id, r, inp.value), 700));
        };
        inp.onblur = () => {
          if(timers.has(key)) clearTimeout(timers.get(key)); 
          saveScore(p.id, r, inp.value); 
        };
        
        td.appendChild(inp);
      } else {
        td.textContent = (p.scores && p.scores[r]!=null) ? p.scores[r] : '';
        td.style.color = '#94a3b8';
      }
      tr.appendChild(td);
    }

    // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
    tr.innerHTML += `<td style="font-weight:bold">${p.sum}</td>`;
    tr.innerHTML += `<td>${(p.sum === worst && data.length > 1) ? 'ğŸ’©' : '<span style="font-weight:bold">'+p.rank+'</span>'}</td>`;
    
    // Ø²Ø± Ø§Ù„Ø­Ø°Ù
    if(isAdmin) {
      tr.innerHTML += `<td><button onclick="deletePlayer('${p.id}')" style="background:#fee2e2;color:red;padding:4px 8px;font-size:12px;border-radius:6px">Ã—</button></td>`;
    }
    tbody.appendChild(tr);
  });
}

/* ===== ğŸ› ï¸ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­) ===== */
async function saveScore(pid, rIdx, val) {
  if(!roomRef) return;
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ø±Ù‚Ù… Ø£Ùˆ null
  let num = null;
  if(val !== '' && val !== '-') num = Number(val);
  
  // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹
  const player = state.players.find(p => p.id === pid);
  if(!player) return;

  // Ù†Ø³Ø® Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¨Ø£Ù…Ø§Ù† (Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯)
  let safeScores = Array.isArray(player.scores) ? [...player.scores] : [];
  
  // Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø¨Ù€ null Ø­ØªÙ‰ Ù†ØµÙ„ Ù„Ø±Ù‚Ù… 10 (Ù„Ù…Ù†Ø¹ Sparse Arrays)
  while(safeScores.length < ROUNDS) {
    safeScores.push(null);
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø©
  safeScores[rIdx] = num;

  try {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ù…Ø¹ merge Ù„Ø¶Ù…Ø§Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù‚Ù„ Ù„Ùˆ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯Ø§Ù‹
    await roomRef.collection('players').doc(pid).set({ 
      scores: safeScores,
      lastUpdate: firebase.firestore.FieldValue.serverTimestamp() // ÙŠØ¬Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    }, { merge: true });
    
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†Ø²Ø¹Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ÙƒÙ„ Ø±Ù‚Ù…
  } catch(e) {
    console.error("Save Error:", e);
    toast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸! (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Øª)', true);
  }
}

async function changeRound(d) {
  if(state.me !== state.owner) return;
  const newR = Math.min(ROUNDS, Math.max(1, state.round + d));
  if(newR !== state.round) await roomRef.update({ currentRound: newR });
}

function subscribe(code) {
  if(roomRef) return;
  roomRef = db.collection('rooms').doc(code);
  state.roomCode = code;

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØºØ±ÙØ©
  roomRef.onSnapshot(doc => {
    if(!doc.exists) {
        state.roomCode = null; roomRef = null;
        renderApp();
        return toast('ğŸš« Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', true);
    }
    const d = doc.data();
    state.owner = d.owner;
    
    const oldRound = state.round;
    state.round = d.currentRound || 1;
    
    renderApp();

    // Auto-Scroll Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if(state.round !== oldRound) {
       setTimeout(() => {
         const active = document.querySelector('.col-active input');
         if(active) active.scrollIntoView({behavior:'smooth', inline:'center'});
       }, 500);
    }
  });

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
  roomRef.collection('players').orderBy('createdAt').onSnapshot(snap => {
    state.players = [];
    snap.forEach(d => state.players.push({ id: d.id, ...d.data() }));
    renderApp();
  }, err => {
    console.error(err);
    toast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª', true);
  });
}

/* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ===== */
document.getElementById('createBtn').onclick = async () => {
  // ÙƒÙˆØ¯ Ø±Ù‚Ù…ÙŠ Ù…Ù† 6 Ø®Ø§Ù†Ø§Øª
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  try {
    await db.collection('rooms').doc(code).set({
      owner: state.me, currentRound: 1, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    subscribe(code);
    toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ğŸš€');
  } catch(e) {
    console.error(e);
    toast('âŒ Ø®Ø·Ø£: Ø±Ø§Ø¬Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†', true);
  }
};

document.getElementById('joinBtn').onclick = async () => {
  const code = document.getElementById('roomCodeInput').value.trim();
  if(!code) return toast('Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯');
  try {
    const d = await db.collection('rooms').doc(code).get();
    if(d.exists) { subscribe(code); toast('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ‘‹'); }
    else toast('Ø§Ù„ÙƒÙˆØ¯ ØºÙ„Ø·!');
  } catch(e) {
    console.error(e);
    toast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true);
  }
};

document.getElementById('addBtn').onclick = async () => {
  const n = document.getElementById('pName').value.trim();
  if(!n) return toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ');
  if(!roomRef) return;
  try {
    await roomRef.collection('players').add({
      name: n, uid: state.me, scores: Array(ROUNDS).fill(null),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('pName').value = '';
    toast('Ù…Ù†ÙˆØ± ÙŠØ§ ' + n);
  } catch(e) { toast('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', true); }
};

function deletePlayer(id) { if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ')) roomRef.collection('players').doc(id).delete(); }
async function clearAll() {
  if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŸ')) {
    const snap = await roomRef.collection('players').get();
    const batch = db.batch(); snap.forEach(d=>batch.delete(d.ref));
    await batch.commit();
    toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­');
  }
}
function calcResult() {
  const sorted = [...state.players].sort((a,b) => {
     const sA = (a.scores||[]).reduce((x,y)=>x+(y||0),0);
     const sB = (b.scores||[]).reduce((x,y)=>x+(y||0),0);
     return sA - sB;
  });
  if(sorted.length) toast(`ğŸ‘‘ Ø§Ù„Ù…ØªØµØ¯Ø±: ${sorted[0].name}`);
}
function randomSkip() {
  if(!state.players.length) return;
  const r = state.players[Math.floor(Math.random()*state.players.length)];
  document.getElementById('modalName').textContent = r.name;
  document.getElementById('modal').style.display = 'flex';
}

window.onload = checkUrlForRoom;

</script>
</body>
</html>
