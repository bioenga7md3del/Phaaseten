<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ØªÙ† ÙÙŠØ² â€” Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù†ÙØµÙ„ Ù„Ù„Ø¬ÙˆÙ„Ø§Øª (Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬ÙˆÙ„Ø©)</title>
  <style>
    :root{ --bg:#f3f7ff; --ink:#0b2340; --muted:#6b7a90; --card:#ffffff; --shadow:0 10px 28px rgba(11,35,64,.12);
           --primary:#2563eb; --accent:#22c55e; --warn:#ef4444; --gold:#fbbf24; --silver:#c0c7d1; }
    *{box-sizing:border-box}
    body{font-family:Tahoma,Arial,sans-serif;background:linear-gradient(180deg,#f0f6ff 0%, #f8fbff 40%, #ffffff 100%);min-height:100vh;margin:0;padding:16px;color:var(--ink)}
    .container{max-width:1100px;margin:0 auto; padding-bottom:120px;}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    .hero{padding:18px 20px;background:linear-gradient(90deg,#e8f0ff,#fff);display:flex;align-items:center;gap:14px;border:1px solid #e6eefc}
    .badge{background:#eef4ff;color:#234; padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #dbe7ff}
    h1{font-size:22px;margin:6px 0}
    p{margin:0;color:var(--muted)}
    input[type=text], input[type=number], select{padding:12px 14px;border-radius:12px;border:1px solid #d8e4f5;background:#fafcff;outline:none;transition:.2s}
    input[type=number]{width:120px; text-align:left; direction:ltr}
    .toolbar, .roombar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .roombar input{max-width:160px}
    button{padding:12px 16px;border-radius:12px;border:0;background:var(--primary);color:#fff;cursor:pointer;transition:transform .06s ease, opacity .2s;box-shadow:0 6px 16px rgba(37,99,235,.18);min-height:44px}
    button.ghost{background:#eaf2ff;color:#123;border:1px solid #d7e6ff;box-shadow:none}
    button.warn{background:var(--warn)}
    button.good{background:var(--accent)}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:12px;border:1px solid #e8f1ff}
    table{width:max(900px,100%);border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef4fb;text-align:center;white-space:nowrap}
    tbody tr:nth-child(odd){background:#fcfeff}
    .first{background:linear-gradient(90deg,#fffbeb,#fff4cc); border-inline-start:6px solid var(--gold)}
    .second{background:linear-gradient(90deg,#f7f8fc,#eef2f7); border-inline-start:6px solid var(--silver)}
    .last{background:linear-gradient(90deg,#fff1f2,#ffe4e6); border-inline-start:6px solid var(--warn)}
    .toast{position:fixed;inset-inline:0;bottom:100px;margin:auto;max-width:380px;background:#0b2340;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(12px);pointer-events:none;transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}
    .bottom-bar{position:fixed;inset-inline:0;bottom:0;background:#ffffffcc;backdrop-filter:blur(6px);border-top:1px solid #e7eefc;padding:10px;display:none;gap:8px}
    .bottom-bar > button{flex:1}
    .roundbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .chip{background:#eef4ff;border:1px solid #d7e6ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .pill{padding:10px 12px;border-radius:12px;background:#eaf2ff;border:1px solid #d7e6ff}
    .entry{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    @media (max-width: 640px){
      body{padding:12px}
      .container{padding:0; padding-bottom:130px;}
      .hero{flex-direction:column;align-items:flex-start}
      .toolbar input, .roombar input, .entry input, .entry select{flex:1;max-width:none}
      .toolbar button, .roombar button, .entry button{flex:1}
      th,td{padding:8px 6px}
      .bottom-bar{display:flex}
      .toast{bottom:110px}
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="card hero">
      <div class="badge">ØªÙ† ÙÙŠØ²</div>
      <div>
        <h1>Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ³Ø¬ÙŠÙ„ Ù†Ù‚Ø§Ø· â€” Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù†ÙØµÙ„ Ù„Ù„Ø¬ÙˆÙ„Ø§Øª</h1>
        <p>Ø£Ù‚Ù„ Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ùˆ Ø§Ù„ÙØ§Ø¦Ø² ğŸ‘‘ â€” Ø¢Ø®Ø± ØªØ±ØªÙŠØ¨ = Ø§Ù„ÙƒÙˆØ² ğŸª£</p>
      </div>
    </div>

    <!-- ØºØ±ÙØ© + Ø§Ù„Ø¬ÙˆÙ„Ø§Øª -->
    <div class="card">
      <div class="roombar">
        <input id="roomCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©"/>
        <button id="createRoom" class="good">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
        <button id="joinRoom" class="ghost">Ø¯Ø®ÙˆÙ„</button>
        <div style="flex:1"></div>
        <span id="roomStatus" class="badge">ØºÙŠØ± Ù…ØªØµÙ„</span>
      </div>
      <div class="roundbar">
        <button id="prevRound" class="ghost">âŸµ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
        <span id="roundBadge" class="chip">Ø¬ÙˆÙ„Ø© 1 / 10</span>
        <button id="nextRound" class="ghost">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© âŸ¶</button>
        <button id="toggleMode" class="pill">ÙˆØ¶Ø¹ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª (Ù…Ø±ÙƒÙ‘Ø²)</button>
      </div>
      <p style="margin-top:8px;color:#6b7a90;font-size:13px">Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„: Ø¯Ø®Ù„ Ø¯Ø±Ø¬ØªÙƒ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ØªØ­ØªØŒ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø·.</p>
    </div>

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬ØªÙŠ (Ù…Ù†ÙØµÙ„) -->
    <div class="card">
      <div class="entry">
        <select id="myPlayerSelect" title="Ø§Ø®ØªÙØ± Ù„Ø§Ø¹Ø¨Ùƒ"></select>
        <input id="myScore" type="number" inputmode="numeric" placeholder="Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"/>
        <button id="saveScore" class="good">Ø­ÙØ¸ Ø¯Ø±Ø¬ØªÙŠ</button>
        <button id="addPlayer" class="ghost">+ Ø£Ø¶Ù Ù„Ø§Ø¹Ø¨</button>
        <button id="deleteMine" class="warn">Ø­Ø°Ù Ù„Ø§Ø¹Ø¨ÙŠ</button>
      </div>
      <p style="margin-top:8px;color:#6b7a90;font-size:12px">Ù…Ù„Ø­ÙˆØ¸Ø©: ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØ¹Ø¯Ù‘Ù„ ØµÙÙ‘Ù‡ ÙÙ‚Ø·. Ù„Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒØ§Ù† Ø£Ø¶Ø§ÙÙƒ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ø§Ù…Ø³Ø­ Ø§Ù„ØµÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ£Ø¶Ù Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø¨Ù†ÙØ³Ùƒ.</p>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© -->
    <div class="card">
      <div class="toolbar">
        <button id="calc" class="good">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        <button id="clearMyScores" class="ghost">Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ÙŠ (ÙƒÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª)</button>
        <div style="flex:1"></div>
        <button id="clearAll" class="warn">Ù…Ø³Ø­ ÙƒÙ„ Ù„Ø§Ø¹Ø¨ÙŠ Ø§Ù„ØºØ±ÙØ© (Ø£Ø¯Ù…Ù†)</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="card">
      <div class="table-wrap">
        <table id="playersTable">
          <thead>
            <tr id="theadRow">
              <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
              <!-- Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø§Øª ØªØªÙˆÙ„Ù‘Ø¯ ÙƒÙ†Øµ ÙÙ‚Ø· -->
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
              <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div class="bottom-bar">
    <button id="mCalc" class="good">Ø§Ø­Ø³Ø¨</button>
    <button id="mClear" class="ghost">Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ÙŠ</button>
  </div>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC5Dh7bJzPqLaZl4djKCgpzaHHSeeD1aHU",
  authDomain: "phaseten-435bf.firebaseapp.com",
  projectId: "phaseten-435bf",
  storageBucket: "phaseten-435bf.firebasestorage.app",
  messagingSenderId: "780298483879",
  appId: "1:780298483879:web:6b6627e673d4808e098382",
  measurementId: "G-58E5DVZHZ6"
};
try{ firebase.initializeApp(firebaseConfig); }catch(e){}
const db = firebase.firestore();

/* Auth */
let myUid=null, authReady=false, waiters=[];
function ensureAuth(){ if(authReady) return Promise.resolve(); return new Promise(r=>waiters.push(r)); }
document.addEventListener('DOMContentLoaded', ()=>{ document.querySelectorAll('button,input,select').forEach(el=>el.disabled=true); });
firebase.auth().onAuthStateChanged(async (u)=>{
  if(!u){ try{ await firebase.auth().signInAnonymously(); }catch(e){ console.error(e); alert('ÙØ¹Ù‘Ù„ Anonymous Auth'); } }
  else{
    myUid=u.uid; authReady=true; waiters.forEach(fn=>fn()); waiters.length=0;
    document.querySelectorAll('button,input,select').forEach(el=>el.disabled=false);
    document.getElementById('roomStatus').textContent='Ø¬Ø§Ù‡Ø²';
  }
});

/* Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© */
const roundsCount=10;
let currentRound=1;
let singleRoundMode = window.matchMedia('(max-width: 640px)').matches;
let roomRef=null, unsubPlayers=null, unsubRoom=null, roomOwner=null;
let myPlayers = []; // [{id,name}]
let currentPlayerId = null;

/* helpers */
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function getTotal(scores){ return (scores||[]).reduce((s,v)=> s+(Number.isFinite(v)?v:0),0); }
function updateRoundBadge(){ document.getElementById('roundBadge').textContent=`Ø¬ÙˆÙ„Ø© ${currentRound} / ${roundsCount}`; }
function renderHeader(){
  const theadRow=document.getElementById('theadRow');
  while(theadRow.children.length>1) theadRow.removeChild(theadRow.children[1]);
  // Ù†Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø¬ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ ÙƒÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª (Ù†Øµ ÙÙ‚Ø·)
  const addTh=r=>{ const th=document.createElement('th'); th.textContent=`Ø¬ÙˆÙ„Ø© ${r}`; theadRow.insertBefore(th, theadRow.children[1]); };
  if(singleRoundMode){ addTh(currentRound); } else { for(let r=1;r<=roundsCount;r++) addTh(r); }
}
function roundIndex(){
  // ÙŠØ­ÙˆÙ‘Ù„ currentRound Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¥Ù„Ù‰ 0..9 Ù…Ù‡Ù…Ø§ Ø­ØµÙ„
  const r = Number(currentRound) || 1;
  return Math.max(0, Math.min(roundsCount - 1, r - 1));
}

/* Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function drawTable(players){
  const arr = players.map(p=>({...p, total:getTotal(p.scores)})).sort((a,b)=>a.total-b.total);
  let rank=1; for(let i=0;i<arr.length;i++){ if(i>0 && arr[i].total===arr[i-1].total){ arr[i].rank=arr[i-1].rank; } else { arr[i].rank=rank; } rank++; }
  const worst = arr.length? arr[arr.length-1].total : null;

  const body=document.getElementById('playersBody');
  body.innerHTML='';
  arr.forEach(p=>{
    const tr=document.createElement('tr');
    if(p.rank===1) tr.classList.add('first'); else if(p.rank===2) tr.classList.add('second');
    if(p.total===worst) tr.classList.add('last');

    const tdName=document.createElement('td'); tdName.textContent=p.name||'â€”'; tr.appendChild(tdName);

    const startR = singleRoundMode ? roundIndex() : 0; // Ù„Ùˆ ÙˆØ¶Ø¹ Ù…Ø±ÙƒÙ‘Ø²ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
    const endR   = singleRoundMode ? startR+1       : roundsCount;
    for(let r=startR; r<endR; r++){
      const td=document.createElement('td');
      const val = (p.scores && p.scores[r]!=null) ? p.scores[r] : 'â€”';
      td.textContent = val; // Ù†Øµ ÙÙ‚Ø·
      tr.appendChild(td);
    }

    const tdTotal=document.createElement('td'); tdTotal.textContent=getTotal(p.scores||Array(roundsCount).fill(null)); tr.appendChild(tdTotal);

    const tdRank=document.createElement('td');
    let label=p.rank!=null?p.rank:'-'; if(p.rank===1) label='Ø§Ù„Ø£ÙˆÙ„ ğŸ‘‘'; else if(p.rank===2) label='Ø§Ù„Ø«Ø§Ù†ÙŠ'; if(p.total===worst) label='Ø§Ù„ÙƒÙˆØ² ğŸª£';
    tdRank.textContent=label; tr.appendChild(tdRank);

    body.appendChild(tr);
  });
}

/* Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ÙŠ */
function populateMyPlayersSelect(allPlayers){
  const sel = document.getElementById('myPlayerSelect');
  myPlayers = allPlayers.filter(p=>p.uid===myUid).map(p=>({id:p.id,name:p.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}));
  sel.innerHTML='';
  if(myPlayers.length===0){
    const opt=document.createElement('option'); opt.value=''; opt.textContent='Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ù„Ùƒ â€” Ø§Ø¶Ù Ù„Ø§Ø¹Ø¨';
    sel.appendChild(opt); currentPlayerId=null;
  }else{
    myPlayers.forEach(pl=>{ const opt=document.createElement('option'); opt.value=pl.id; opt.textContent=pl.name; sel.appendChild(opt); });
    if(!currentPlayerId || !myPlayers.find(p=>p.id===currentPlayerId)){ currentPlayerId = myPlayers[myPlayers.length-1].id; }
    sel.value=currentPlayerId;
  }
}
document.getElementById('myPlayerSelect').addEventListener('change', (e)=>{ currentPlayerId = e.target.value || null; });

/* Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø§Ù„ØºØ±ÙØ© */
function subscribeToRoom(code){
  if(unsubPlayers) unsubPlayers(); if(unsubRoom) unsubRoom();
  roomRef = db.collection('rooms').doc(code);
  unsubRoom = roomRef.onSnapshot(doc=>{ const data=doc.data()||{}; roomOwner=data.owner||null; });
  unsubPlayers = roomRef.collection('players').orderBy('createdAt').onSnapshot(snap=>{
    const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
    drawTable(rows);
    populateMyPlayersSelect(rows);
  }, err=>{ console.error(err); toast('Ù…Ø´ÙƒÙ„Ø© Ø§Ø´ØªØ±Ø§Ùƒ: '+err.message); });
  const rs=document.getElementById('roomStatus'); rs.textContent='ØºØ±ÙØ©: '+code; rs.style.background='#eaffef'; rs.style.border='1px solid #b8f0c8';
  toast('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØºØ±ÙØ© '+code);
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬ÙˆÙ„Ø§Øª */
document.getElementById('prevRound').addEventListener('click', ()=>{ currentRound=Math.max(1,currentRound-1); renderHeader(); updateRoundBadge(); if(roomRef) subscribeToRoom(roomRef.id); });
document.getElementById('nextRound').addEventListener('click', ()=>{ currentRound=Math.min(roundsCount,currentRound+1); renderHeader(); updateRoundBadge(); if(roomRef) subscribeToRoom(roomRef.id); });
document.getElementById('toggleMode').addEventListener('click', ()=>{ singleRoundMode=!singleRoundMode; renderHeader(); updateRoundBadge(); if(roomRef) subscribeToRoom(roomRef.id); toast(singleRoundMode?'ÙˆØ¶Ø¹ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª (Ù…Ø±ÙƒÙ‘Ø²)':'Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª'); });

/* Ø¥Ù†Ø´Ø§Ø¡/Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ© */
function randomCode(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }
document.getElementById('createRoom').addEventListener('click', async ()=>{
  try{
    await ensureAuth();
    const code=randomCode();
    await db.collection('rooms').doc(code).set({ createdAt:firebase.firestore.FieldValue.serverTimestamp(), owner: myUid });
    document.getElementById('roomCode').value=code; subscribeToRoom(code);
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: '+e.message); }
});
document.getElementById('joinRoom').addEventListener('click', async ()=>{
  try{
    await ensureAuth();
    const code=(document.getElementById('roomCode').value||'').trim().toUpperCase();
    if(!code){ toast('Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©'); return; }
    const d=await db.collection('rooms').doc(code).get();
    if(!d.exists){ toast('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
    subscribeToRoom(code);
  }catch(e){ console.error(e); toast('ØªØ¹Ø°Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: '+e.message); }
});

/* Ø¥Ø¯Ø§Ø±Ø© Ù„Ø§Ø¹Ø¨ÙŠ */
document.getElementById('addPlayer').addEventListener('click', async ()=>{
  try{
    await ensureAuth();
    if(!roomRef){ toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§'); return; }
    const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ') || '';
    if(!name.trim()){ toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨'); return; }
    const docRef = await roomRef.collection('players').add({
      name: name.trim(), uid: myUid, scores:Array(roundsCount).fill(null),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    currentPlayerId = docRef.id;
    populateMyPlayersSelect(myPlayers.map(x=>x)); // ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
    toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ù„Ùƒ');
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨: '+e.message); }
});

document.getElementById('deleteMine').addEventListener('click', async ()=>{
  try{
    await ensureAuth();
    if(!roomRef){ toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§'); return; }
    if(!currentPlayerId){ toast('Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ùƒ Ø£ÙˆÙ„Ù‹Ø§'); return; }
    if(!confirm('Ø­Ø°Ù Ù„Ø§Ø¹Ø¨ÙƒØŸ')) return;
    await roomRef.collection('players').doc(currentPlayerId).delete();
    currentPlayerId=null; document.getElementById('myPlayerSelect').value='';
    toast('ØªÙ… Ø­Ø°Ù Ù„Ø§Ø¹Ø¨Ùƒ');
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø­Ø°Ù Ù„Ø§Ø¹Ø¨Ùƒ: '+e.message); }
});

/* Ø­ÙØ¸ Ø¯Ø±Ø¬ØªÙŠ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¹Ø¨Ø± roundIndex) */
document.getElementById('saveScore').addEventListener('click', async ()=>{
  try{
    await ensureAuth();
    if(!roomRef){ toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§'); return; }
    if(!currentPlayerId){ toast('Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ùƒ Ø£ÙˆÙ„Ù‹Ø§ Ø£Ùˆ Ø£Ø¶Ù Ù„Ø§Ø¹Ø¨'); return; }
    const vEl=document.getElementById('myScore'); const v=vEl.value.trim();
    if(v==='' || isNaN(Number(v))){ toast('Ø§ÙƒØªØ¨ Ø¯Ø±Ø¬Ø© ØµØ­ÙŠØ­Ø©'); return; }

    const ref = roomRef.collection('players').doc(currentPlayerId);
    const snap = await ref.get();
    if(!snap.exists){ toast('Ù„Ø§Ø¹Ø¨Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
    if(snap.data().uid !== myUid){ toast('ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ù„Ø§Ø¹Ø¨Ùƒ ÙÙ‚Ø·'); return; }

    const scores = Array.isArray(snap.data().scores) ? [...snap.data().scores] : Array(roundsCount).fill(null);
    const idx = roundIndex(); // â† Ø§Ù„Ø¶Ù…Ø§Ù†
    scores[idx] = Number(v);

    await ref.update({ scores, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    toast(`Ø§ØªØ­ÙØ¸Øª Ø¯Ø±Ø¬ØªÙƒ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© ${idx+1}`);
    vEl.value='';
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+e.message); }
});

/* Ø¹Ø§Ù… */
document.getElementById('calc').addEventListener('click', async ()=>{
  try{
    await ensureAuth(); if(!roomRef){ toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§'); return; }
    const snap=await roomRef.collection('players').get(); const arr=[];
    snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    const totals=arr.map(p=>({name:p.name, uid:p.uid, total:getTotal(p.scores||[])})).sort((a,b)=>a.total-b.total);
    const best=totals.length?totals[0].total:null, worst=totals.length?totals[totals.length-1].total:null;
    await roomRef.set({leaderboard:totals,lastCalcAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
    const winners=totals.filter(t=>t.total===best).map(t=>t.name).join('ØŒ '), kooz=totals.filter(t=>t.total===worst).map(t=>t.name).join('ØŒ ');
    toast(`Ø§Ù„ÙØ§Ø¦Ø²: ${winners} â€” Ø§Ù„ÙƒÙˆØ²: ${koÙˆØ²}`);
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨: '+e.message); }
});
document.getElementById('clearMyScores').addEventListener('click', async ()=>{
  try{
    await ensureAuth(); if(!roomRef){ toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§'); return; }
    const mine=await roomRef.collection('players').where('uid','==',myUid).get();
    const batch=db.batch(); mine.forEach(d=> batch.update(roomRef.collection('players').doc(d.id), {scores:Array(roundsCount).fill(null)}));
    await batch.commit(); toast('Ø§ØªÙ…Ø³Ø­Øª Ù†ØªØ§Ø¦Ø¬Ùƒ');
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: '+e.message); }
});
document.getElementById('clearAll').addEventListener('click', async ()=>{
  try{
    await ensureAuth(); if(!roomRef){ toast('Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§'); return; }
    const info=await roomRef.get(); const owner=(info.data()||{}).owner;
    if(myUid!==owner){ toast('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·'); return; }
    if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ù„Ø§Ø¹Ø¨ÙŠ Ø§Ù„ØºØ±ÙØ©ØŸ')) return;
    const snap=await roomRef.collection('players').get(); const batch=db.batch(); snap.forEach(d=> batch.delete(roomRef.collection('players').doc(d.id)));
    await batch.commit(); toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­');
  }catch(e){ console.error(e); toast('ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: '+e.message); }
});

/* Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª + ØªÙ†Ù‚Ù„ */
function refreshHeaders(){ renderHeader(); updateRoundBadge(); if(roomRef) subscribeToRoom(roomRef.id); }
document.getElementById('prevRound').addEventListener('click', ()=>{ currentRound=Math.max(1,currentRound-1); refreshHeaders(); });
document.getElementById('nextRound').addEventListener('click', ()=>{ currentRound=Math.min(roundsCount,currentRound+1); refreshHeaders(); });
document.getElementById('toggleMode').addEventListener('click', ()=>{ singleRoundMode=!singleRoundMode; refreshHeaders(); toast(singleRoundMode?'ÙˆØ¶Ø¹ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª (Ù…Ø±ÙƒÙ‘Ø²)':'Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª'); });

/* ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© + ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
renderHeader(); updateRoundBadge();
const bottomBar=document.querySelector('.bottom-bar');
document.addEventListener('focusin', (e)=>{ if(e.target.tagName==='INPUT' || e.target.tagName==='SELECT') bottomBar.style.display='none'; });
document.addEventListener('focusout', ()=>{ if(window.matchMedia('(max-width: 640px)').matches) bottomBar.style.display='flex'; });
document.getElementById('mCalc').addEventListener('click', ()=> document.getElementById('calc').click());
document.getElementById('mClear').addEventListener('click', ()=> document.getElementById('clearMyScores').click());
</script>

<!-- Firestore Rules Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Ù„Ù„Ø¥Ù†ØªØ§Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø©):
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /rooms/{room} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null; // Ø£ÙŠ Ø­Ø¯ ÙŠØ­Ø¯Ù‘Ø« leaderboard
      allow delete: if false;
    }
    match /rooms/{room}/players/{player} {
      allow read: if true;
      // Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø§Ø¹Ø¨ Ù„Ù†ÙØ³Ù‡ ÙÙ‚Ø·
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      // ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨: Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙ‚Ø·
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.uid;
    }
  }
}
-->
</body>
</html>
